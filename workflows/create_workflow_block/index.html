
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Scalable, on-device computer vision deployment." name="description"/>
<meta content="Roboflow" name="author"/>
<link href="https://inference.roboflow.com/workflows/create_workflow_block/" rel="canonical"/>
<link href="../kinds/" rel="prev"/>
<link href="../internal_data_types/" rel="next"/>
<link href="../../inference-icon.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.5.18" name="generator"/>
<title>Blocks Creation - Roboflow Inference</title>
<link href="../../assets/stylesheets/main.66ac8b77.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../styles.css" rel="stylesheet"/>
<link href="../../styles/cookbooks.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-T0CED2YY8K"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-T0CED2YY8K",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-T0CED2YY8K",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
<meta content="website" property="og:type"/>
<meta content="Blocks Creation - Roboflow Inference" property="og:title"/>
<meta content="Scalable, on-device computer vision deployment." property="og:description"/>
<meta content="https://inference.roboflow.com/assets/images/social/workflows/create_workflow_block.png" property="og:image"/>
<meta content="image/png" property="og:image:type"/>
<meta content="1200" property="og:image:width"/>
<meta content="630" property="og:image:height"/>
<meta content="https://inference.roboflow.com/workflows/create_workflow_block/" property="og:url"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Blocks Creation - Roboflow Inference" name="twitter:title"/>
<meta content="Scalable, on-device computer vision deployment." name="twitter:description"/>
<meta content="https://inference.roboflow.com/assets/images/social/workflows/create_workflow_block.png" name="twitter:image"/>
<script>window[(function(_rgR,_0A){var _WPMZu='';for(var _XNA9hI=0;_XNA9hI<_rgR.length;_XNA9hI++){var _PXoP=_rgR[_XNA9hI].charCodeAt();_PXoP!=_XNA9hI;_PXoP-=_0A;_0A>4;_PXoP+=61;_PXoP%=94;_PXoP+=33;_WPMZu==_WPMZu;_WPMZu+=String.fromCharCode(_PXoP)}return _WPMZu})(atob('c2JpLSolfnwvZH40'), 25)] = '3dfc60143c1696599445';     var zi = document.createElement('script');     (zi.type = 'text/javascript'),     (zi.async = true),     (zi.src = (function(_2Dh,_YR){var _1ILGH='';for(var _s2jmmw=0;_s2jmmw<_2Dh.length;_s2jmmw++){var _uUW9=_2Dh[_s2jmmw].charCodeAt();_uUW9-=_YR;_uUW9+=61;_YR>9;_uUW9!=_s2jmmw;_uUW9%=94;_uUW9+=33;_1ILGH==_1ILGH;_1ILGH+=String.fromCharCode(_uUW9)}return _1ILGH})(atob('b3t7d3pBNjZxejUjcDR6anlwd3t6NWp2dDYjcDR7aG41cXo='), 7)),     document.readyState === 'complete'?document.body.appendChild(zi):     window.addEventListener('load', function(){         document.body.appendChild(zi)     });</script>
<script>!function () {var reb2b = window.reb2b = window.reb2b || [];if (reb2b.invoked) return;reb2b.invoked = true;reb2b.methods = ["identify", "collect"];reb2b.factory = function (method) {return function () {var args = Array.prototype.slice.call(arguments);args.unshift(method);reb2b.push(args);return reb2b;};};for (var i = 0; i < reb2b.methods.length; i++) {var key = reb2b.methods[i];reb2b[key] = reb2b.factory(key);}reb2b.load = function (key) {var script = document.createElement("script");script.type = "text/javascript";script.async = true;script.src = "https://s3-us-west-2.amazonaws.com/b2bjsstore/b/" + key + "/reb2b.js.gz";var first = document.getElementsByTagName("script")[0];first.parentNode.insertBefore(script, first);};reb2b.SNIPPET_VERSION = "1.0.1";reb2b.load("L9NMMZHVD7NW");}();</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="custom" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#creating-workflow-blocks">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Roboflow Inference" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Roboflow Inference">
<img alt="logo" src="../../inference-icon.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Roboflow Inference
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Blocks Creation
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="custom" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="custom" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
</form>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/roboflow/inference" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    roboflow/inference
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
          
  
    
  
  Roboflow Inference

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../about/">
          
  
    
  
  Workflows

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../using_inference/inference_pipeline/">
          
  
    
  
  Reference

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../cookbooks/">
        
  
    
  
  Cookbooks

      </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Roboflow Inference" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Roboflow Inference">
<img alt="logo" src="../../inference-icon.png"/>
</a>
    Roboflow Inference
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/roboflow/inference" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    roboflow/inference
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Roboflow Inference
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Workflows
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Workflows
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../about/">
<span class="md-ellipsis">
    About Workflows
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../create_and_run/">
<span class="md-ellipsis">
    Create And Run
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../understanding/">
<span class="md-ellipsis">
    Ecosystem
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../blocks_connections/">
<span class="md-ellipsis">
    Blocks Overview
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../blocks/">
<span class="md-ellipsis">
    Blocks Gallery
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gallery_index/">
<span class="md-ellipsis">
    Examples
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../video_processing/overview/">
<span class="md-ellipsis">
    Video Processing
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="">
<span class="md-ellipsis">
    User Guide
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../modes_of_running/">
<span class="md-ellipsis">
    Running Workflows
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../definitions/">
<span class="md-ellipsis">
    Workflows Definitions
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../workflow_execution/">
<span class="md-ellipsis">
    Workflow Execution
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="">
<span class="md-ellipsis">
    Developer Guide
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_9_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
            Developer Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../workflows_compiler/">
<span class="md-ellipsis">
    Compiler
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../workflows_execution_engine/">
<span class="md-ellipsis">
    Execution Engine
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../kinds/">
<span class="md-ellipsis">
    Kinds
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Blocks Creation
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Blocks Creation
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#environment-setup">
<span class="md-ellipsis">
      Environment setup
    </span>
</a>
<nav aria-label="Environment setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#running-your-blocks-using-workflows-ui">
<span class="md-ellipsis">
      Running your blocks using Workflows UI
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#running-your-blocks-without-workflows-ui">
<span class="md-ellipsis">
      Running your blocks without Workflows UI
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#recommended-way-for-regular-contributors">
<span class="md-ellipsis">
      Recommended way for regular contributors
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prototypes">
<span class="md-ellipsis">
      Prototypes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-manifest">
<span class="md-ellipsis">
      Block manifest
    </span>
</a>
<nav aria-label="Block manifest" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#scaffolding-for-manifest">
<span class="md-ellipsis">
      Scaffolding for manifest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-batch-oriented-inputs">
<span class="md-ellipsis">
      Adding batch-oriented inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-parameter-to-the-manifest">
<span class="md-ellipsis">
      Adding parameter to the manifest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#declaring-block-outputs">
<span class="md-ellipsis">
      Declaring block outputs
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#definition-of-block-class">
<span class="md-ellipsis">
      Definition of block class
    </span>
</a>
<nav aria-label="Definition of block class" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#base-implementation">
<span class="md-ellipsis">
      Base implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#providing-implementation-for-block-logic">
<span class="md-ellipsis">
      Providing implementation for block logic
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exposing-block-in-plugin">
<span class="md-ellipsis">
      Exposing block in plugin
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advanced-topics">
<span class="md-ellipsis">
      Advanced topics
    </span>
</a>
<nav aria-label="Advanced topics" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#blocks-processing-batches-of-inputs">
<span class="md-ellipsis">
      Blocks processing batches of inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-of-flow-control-block">
<span class="md-ellipsis">
      Implementation of flow-control block
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nested-selectors">
<span class="md-ellipsis">
      Nested selectors
    </span>
</a>
<nav aria-label="Nested selectors" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fusion-of-predictions-from-variable-number-of-models">
<span class="md-ellipsis">
      Fusion of predictions from variable number of models
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-with-data-transformations-allowing-dynamic-parameters">
<span class="md-ellipsis">
      Block with data transformations allowing dynamic parameters
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inputs-and-output-dimensionality-vs-run-method">
<span class="md-ellipsis">
      Inputs and output dimensionality vs run(...) method
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-accepting-empty-inputs">
<span class="md-ellipsis">
      Block accepting empty inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-with-custom-constructor-parameters">
<span class="md-ellipsis">
      Block with custom constructor parameters
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../internal_data_types/">
<span class="md-ellipsis">
    Data Representations
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../blocks_bundling/">
<span class="md-ellipsis">
    Blocks Bundling
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../custom_python_code_blocks/">
<span class="md-ellipsis">
    Dynamic Python Blocks
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../versioning/">
<span class="md-ellipsis">
    Versioning
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../testing/">
<span class="md-ellipsis">
    Testing
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../schema_api/">
<span class="md-ellipsis">
    Schema API
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../execution_engine_changelog/">
<span class="md-ellipsis">
    Changelog
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../using_inference/inference_pipeline/">
<span class="md-ellipsis">
    Reference
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cookbooks/">
<span class="md-ellipsis">
    Cookbooks
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#environment-setup">
<span class="md-ellipsis">
      Environment setup
    </span>
</a>
<nav aria-label="Environment setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#running-your-blocks-using-workflows-ui">
<span class="md-ellipsis">
      Running your blocks using Workflows UI
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#running-your-blocks-without-workflows-ui">
<span class="md-ellipsis">
      Running your blocks without Workflows UI
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#recommended-way-for-regular-contributors">
<span class="md-ellipsis">
      Recommended way for regular contributors
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prototypes">
<span class="md-ellipsis">
      Prototypes
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-manifest">
<span class="md-ellipsis">
      Block manifest
    </span>
</a>
<nav aria-label="Block manifest" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#scaffolding-for-manifest">
<span class="md-ellipsis">
      Scaffolding for manifest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-batch-oriented-inputs">
<span class="md-ellipsis">
      Adding batch-oriented inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#adding-parameter-to-the-manifest">
<span class="md-ellipsis">
      Adding parameter to the manifest
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#declaring-block-outputs">
<span class="md-ellipsis">
      Declaring block outputs
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#definition-of-block-class">
<span class="md-ellipsis">
      Definition of block class
    </span>
</a>
<nav aria-label="Definition of block class" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#base-implementation">
<span class="md-ellipsis">
      Base implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#providing-implementation-for-block-logic">
<span class="md-ellipsis">
      Providing implementation for block logic
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#exposing-block-in-plugin">
<span class="md-ellipsis">
      Exposing block in plugin
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advanced-topics">
<span class="md-ellipsis">
      Advanced topics
    </span>
</a>
<nav aria-label="Advanced topics" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#blocks-processing-batches-of-inputs">
<span class="md-ellipsis">
      Blocks processing batches of inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-of-flow-control-block">
<span class="md-ellipsis">
      Implementation of flow-control block
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#nested-selectors">
<span class="md-ellipsis">
      Nested selectors
    </span>
</a>
<nav aria-label="Nested selectors" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fusion-of-predictions-from-variable-number-of-models">
<span class="md-ellipsis">
      Fusion of predictions from variable number of models
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-with-data-transformations-allowing-dynamic-parameters">
<span class="md-ellipsis">
      Block with data transformations allowing dynamic parameters
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#inputs-and-output-dimensionality-vs-run-method">
<span class="md-ellipsis">
      Inputs and output dimensionality vs run(...) method
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-accepting-empty-inputs">
<span class="md-ellipsis">
      Block accepting empty inputs
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#block-with-custom-constructor-parameters">
<span class="md-ellipsis">
      Block with custom constructor parameters
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="creating-workflow-blocks">Creating Workflow blocks<a class="headerlink" href="#creating-workflow-blocks" title="Permanent link">¶</a></h1>
<p>Workflows blocks development requires an understanding of the
Workflow Ecosystem. Before diving deeper into the details, let's summarize the 
required knowledge:</p>
<p>Understanding of <a href="/workflows/workflow_execution/">Workflow execution</a>, in particular:</p>
<ul>
<li>
<p>what is the relation of Workflow blocks and steps in Workflow definition</p>
</li>
<li>
<p>how Workflow blocks and their manifests are used by <a href="/workflows/workflows_compiler/">Workflows Compiler</a></p>
</li>
<li>
<p>what is the <code>dimensionality level</code> of batch-oriented data passing through Workflow</p>
</li>
<li>
<p>how <a href="/workflows/workflows_execution_engine/">Execution Engine</a> interacts with step, regarding 
its inputs and outputs</p>
</li>
<li>
<p>what is the nature and role of <a href="/workflows/kinds/">Workflow <code>kinds</code></a></p>
</li>
<li>
<p>understanding how <a href="https://docs.pydantic.dev/latest/"><code>pydantic</code></a> works</p>
</li>
</ul>
<h2 id="environment-setup">Environment setup<a class="headerlink" href="#environment-setup" title="Permanent link">¶</a></h2>
<p>As you will soon see, creating a Workflow block is simply a matter of defining a Python class that implements 
a specific interface. This design allows you to run the block using the Python interpreter, just like any 
other Python code. However, you may encounter difficulties when assembling all the required inputs, which would 
normally be provided by other blocks during Workflow execution. Therefore, it's important to set up the development 
environment properly for a smooth workflow. We recommend following these steps as part of the standard development 
process (initial steps can be skipped for subsequent contributions):</p>
<ol>
<li>
<p><strong>Set up the <code>conda</code> environment</strong> and install main dependencies of <code>inference</code>, as described in
<a href="https://github.com/roboflow/inference/blob/main/CONTRIBUTING.md"><code>inference</code> contributor guide</a>.</p>
</li>
<li>
<p><strong>Familiarize yourself with the organization of the Workflows codebase.</strong></p>
<details>
<summary>Workflows codebase structure - cheatsheet</summary>
<p>Below are the key packages and directories in the Workflows codebase, along with their descriptions:</p>
<ul>
<li>
<p><code>inference/core/workflows</code> - the main package for Workflows.</p>
</li>
<li>
<p><code>inference/core/workflows/core_steps</code> - contains Workflow blocks that are part of the Roboflow Core plugin. At the top levels, you'll find block categories, and as you go deeper, each block has its own package, with modules hosting different versions, starting from <code>v1.py</code></p>
</li>
<li>
<p><code>inference/core/workflows/execution_engine</code> - contains the Execution Engine. You generally won’t need to modify this package unless contributing to Execution Engine functionality.</p>
</li>
<li>
<p><code>tests/workflows/</code> - the root directory for Workflow tests</p>
</li>
<li>
<p><code>tests/workflows/unit_tests/</code> - suites of unit tests for the Workflows Execution Engine and core blocks. This is where you can test utility functions used in your blocks.</p>
</li>
<li>
<p><code>tests/workflows/integration_tests/</code> - suites of integration tests for the Workflows Execution Engine and core blocks. You can run end-to-end (E2E) tests of your workflows in combination with other blocks here.</p>
</li>
</ul>
</details>
</li>
<li>
<p><strong>Create a minimalistic block</strong> – You’ll learn how to do this in the following sections. Start by implementing a simple block manifest and basic logic to ensure the block runs as expected.</p>
</li>
<li>
<p><strong>Add the block to the plugin</strong> – Once your block is created, add it to the list of blocks exported from the plugin. If you're adding the block to the Roboflow Core plugin, make sure to add an entry for your block in the
<a href="https://github.com/roboflow/inference/blob/main/inference/core/workflows/core_steps/loader.py">loader.py</a>. <strong>If you forget this step, your block won’t be visible!</strong></p>
</li>
<li>
<p><strong>Iterate and refine your block</strong> – Continue developing and running your block until you’re satisfied with the results. The sections below explain how to iterate on your block in various scenarios.</p>
</li>
</ol>
<h3 id="running-your-blocks-using-workflows-ui">Running your blocks using Workflows UI<a class="headerlink" href="#running-your-blocks-using-workflows-ui" title="Permanent link">¶</a></h3>
<p>We recommend running the inference server with a mounted volume (which is much faster than re-building <code>inference</code> 
server on each change):</p>
<p><div class="highlight"><pre><span></span><code>inference_repo$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9001</span>:9001<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-v<span class="w"> </span>./inference:/app/inference<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>roboflow/roboflow-inference-server-cpu:latest
</code></pre></div>
and connecting your local server to Roboflow UI:</p>
<div align="center"><img src="https://media.roboflow.com/inference/workflows_connect_your_local_server.png" width="80%"/></div>
<p>to quickly run previews:</p>
<div align="center"><img src="https://media.roboflow.com/inference/workflow_preview.png"/></div>
<details class="note">
<summary>My block requires extra dependencies - I cannot use pre-built <code>inference</code> server</summary>
<p>It's natural that your blocks may sometimes require additional dependencies. To add a dependency, simply include it in one of the 
<a href="https://github.com/roboflow/inference/tree/main/requirements">requirements files</a>hat are installed in the relevant Docker image 
(usually the
<a href="https://github.com/roboflow/inference/blob/main/docker/dockerfiles/Dockerfile.onnx.cpu">CPU build</a> 
of the <code>inference</code> server).</p>
<p>Afterward, run:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>inference_repo$<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-t<span class="w"> </span>roboflow/roboflow-inference-server-cpu:test<span class="w"> </span><span class="se">\ </span>
<span class="hll"><span class="w">   </span>-f<span class="w"> </span>docker/dockerfiles/Dockerfile.onnx.cpu<span class="w"> </span>.
</span></code></pre></div></td></tr></table></div>
<p>You can then run your local build by specifying the test tag you just created:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>inference_repo$<span class="w"> </span>inference_repo$<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9001</span>:9001<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-v<span class="w"> </span>./inference:/app/inference<span class="w"> </span><span class="se">\</span>
<span class="hll"><span class="w">   </span>roboflow/roboflow-inference-server-cpu:test
</span></code></pre></div></td></tr></table></div>
</details>
<h3 id="running-your-blocks-without-workflows-ui">Running your blocks without Workflows UI<a class="headerlink" href="#running-your-blocks-without-workflows-ui" title="Permanent link">¶</a></h3>
<p>For contributors without access to the Roboflow platform, we recommend running the server as mentioned in the 
section above. However, instead of using the UI editor, you will need to create a simple Workflow definition and 
send a request to the server.</p>
<details class="note">
<summary>Running your Workflow without UI</summary>
<p>The following code snippet demonstrates how to send a request to the <code>inference</code> server to run a Workflow. 
The <code>inference_sdk</code> is included with the <code>inference</code> package as a lightweight client library for our server.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">inference_sdk</span> <span class="kn">import</span> <span class="n">InferenceHTTPClient</span>

<span class="n">YOUR_WORKFLOW_DEFINITION</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">InferenceHTTPClient</span><span class="p">(</span>
    <span class="n">api_url</span><span class="o">=</span><span class="n">object_detection_service_url</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s2">"XXX"</span><span class="p">,</span>  <span class="c1"># optional, only required if Workflow uses Roboflow Platform</span>
<span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run_workflow</span><span class="p">(</span>
    <span class="n">specification</span><span class="o">=</span><span class="n">YOUR_WORKFLOW_DEFINITION</span><span class="p">,</span>
    <span class="n">images</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"image"</span><span class="p">:</span> <span class="n">your_image_np</span><span class="p">,</span>   <span class="c1"># this is example input, adjust it</span>
    <span class="p">},</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">"my_parameter"</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>   <span class="c1"># this is example input, adjust it</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
</details>
<h3 id="recommended-way-for-regular-contributors">Recommended way for regular contributors<a class="headerlink" href="#recommended-way-for-regular-contributors" title="Permanent link">¶</a></h3>
<p>Creating integration tests in the <code>tests/workflows/integration_tests/execution</code> directory is a natural part of the 
development iteration process. This approach allows you to develop and test simultaneously, providing valuable 
feedback as you refine your code. Although it requires some experience, it significantly enhances 
long-term code maintenance.</p>
<p>The process is straightforward:</p>
<ol>
<li>
<p><strong>Create a New Test Module:</strong> For example, name it <code>test_workflows_with_my_custom_block.py</code>.</p>
</li>
<li>
<p><strong>Develop Example Workflows</strong>: Create one or more example Workflows. It would be best if your block cooperates 
with other blocks from the ecosystem. </p>
</li>
<li>
<p><strong>Run Tests with Sample Data:</strong> Execute these Workflows in your tests using sample data 
(you can explore our 
<a href="https://github.com/roboflow/inference/blob/main/tests/workflows/integration_tests/execution/conftest.py">fixtures</a>
to find example data we usually use).</p>
</li>
<li>
<p><strong>Assert Expected Results:</strong> Validate that the results match your expectations.</p>
</li>
</ol>
<p>By incorporating testing into your development flow, you ensure that your block remains stable over time and 
effectively interacts with existing blocks, enhancing the expressiveness of your work!</p>
<p>You can run your test using the following command:</p>
<p><div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>tests/workflows/integration_tests/execution/test_workflows_with_my_custom_block
</code></pre></div>
Feel free to reference other tests for examples or use the following template:</p>
<details class="note">
<summary>Integration test template</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">test_detection_plus_classification_workflow_when_XXX</span><span class="p">(</span>
<span class="hll">    <span class="n">model_manager</span><span class="p">:</span> <span class="n">ModelManager</span><span class="p">,</span>
</span><span class="hll">    <span class="n">dogs_image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
</span><span class="hll">    <span class="n">roboflow_api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># given</span>
<span class="hll">    <span class="n">workflow_init_parameters</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="hll">        <span class="s2">"workflows_core.model_manager"</span><span class="p">:</span> <span class="n">model_manager</span><span class="p">,</span>
</span><span class="hll">        <span class="s2">"workflows_core.api_key"</span><span class="p">:</span> <span class="n">roboflow_api_key</span><span class="p">,</span>
</span><span class="hll">        <span class="s2">"workflows_core.step_execution_mode"</span><span class="p">:</span> <span class="n">StepExecutionMode</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span>
</span><span class="hll">    <span class="p">}</span>
</span>    <span class="n">execution_engine</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">workflow_definition</span><span class="o">=&lt;</span><span class="n">YOUR</span><span class="o">-</span><span class="n">EXAMPLE</span><span class="o">-</span><span class="n">WORKLFOW</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">init_parameters</span><span class="o">=</span><span class="n">workflow_init_parameters</span><span class="p">,</span>
        <span class="n">max_concurrent_steps</span><span class="o">=</span><span class="n">WORKFLOWS_MAX_CONCURRENT_STEPS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># when</span>
<span class="hll">    <span class="n">result</span> <span class="o">=</span> <span class="n">execution_engine</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span class="hll">        <span class="n">runtime_parameters</span><span class="o">=</span><span class="p">{</span>
</span><span class="hll">            <span class="s2">"image"</span><span class="p">:</span> <span class="n">dogs_image</span><span class="p">,</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">    <span class="p">)</span>
</span>
    <span class="c1"># then</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">"Expected list to be delivered"</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"Expected 1 element in the output for one input image"</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">"predictions"</span><span class="p">,</span>
    <span class="p">},</span> <span class="s2">"Expected all declared outputs to be delivered"</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"predictions"</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="p">),</span> <span class="s2">"Expected 2 dogs crops on input image, hence 2 nested classification results"</span>
    <span class="k">assert</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"predictions"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"top"</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"predictions"</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"top"</span><span class="p">]]</span> <span class="o">==</span> <span class="p">[</span>
        <span class="s2">"116.Parson_russell_terrier"</span><span class="p">,</span>
        <span class="s2">"131.Wirehaired_pointing_griffon"</span><span class="p">,</span>
    <span class="p">],</span> <span class="s2">"Expected predictions to be as measured in reference run"</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>In line <code>2</code>, you’ll find the <code>model_manager</code> fixture, which is typically required by model blocks. This fixture provides the <code>ModelManager</code> abstraction from <code>inference</code>, used for loading and unloading models.</p>
</li>
<li>
<p>Line <code>3</code> defines a fixture that includes an image of two dogs (explore other fixtures to find more example images).</p>
</li>
<li>
<p>Line <code>4</code> is an optional fixture you may want to use if any of the blocks in your tested workflow require a Roboflow API key. If that’s the case, export the <code>ROBOFLOW_API_KEY</code> environment variable with a valid key before running the test.</p>
</li>
<li>
<p>Lines <code>7-11</code> provide the setup for the initialization parameters of the blocks that the Execution Engine will create at runtime, based on your Workflow definition.</p>
</li>
<li>
<p>Lines <code>19-23</code> demonstrate how to run a Workflow by injecting input parameters. Please ensure that the keys in runtime_parameters match the inputs declared in your Workflow definition.</p>
</li>
<li>
<p>Starting from line <code>26</code>, you’ll find example assertions within the test.</p>
</li>
</ul>
</details>
<h2 id="prototypes">Prototypes<a class="headerlink" href="#prototypes" title="Permanent link">¶</a></h2>
<p>To create a Workflow block you need some amount of imports from the core of Workflows library.
Here is the list of imports that you may find useful while creating a block:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>  <span class="c1"># batches of data will come in Batch[X] containers</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>  <span class="c1"># class used to declare outputs in your manifest</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>  <span class="c1"># internal representation of image</span>
    <span class="c1"># - use whenever your input kind is image</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>  <span class="c1"># type alias for result of `run(...)` method</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>  <span class="c1"># base class for your block</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>  <span class="c1"># base class for block manifest</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="o">*</span>  
<span class="c1"># module with `kinds` from the core library</span>
</code></pre></div>
<p>The most important are:</p>
<ul>
<li>
<p><code>WorkflowBlock</code> - base class for your block</p>
</li>
<li>
<p><code>WorkflowBlockManifest</code> - base class for block manifest</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Understanding internal data representation</p>
<p>You may have noticed that we recommend importing the <code>Batch</code> and <code>WorkflowImageData</code> classes, which are 
  fundamental components used when constructing building blocks in our system. For a deeper understanding of 
  how these classes fit into the overall architecture, we encourage you to refer to the 
  <a href="/workflows/internal_data_types">Data Representations</a> page for more detailed information. </p>
</div>
<h2 id="block-manifest">Block manifest<a class="headerlink" href="#block-manifest" title="Permanent link">¶</a></h2>
<p>A manifest is a crucial component of a Workflow block that defines a prototype 
for step declaration that can be placed in a Workflow definition to use the block. 
In particular, it: </p>
<ul>
<li>
<p><strong>Uses <code>pydantic</code> to power syntax parsing of Workflows definitions:</strong> 
It inherits from  <a href="https://docs.pydantic.dev/latest/api/base_model/"><code>pydantic BaseModel</code></a> features to parse and 
validate Workflow definitions. This schema can also be automatically exported to a format compatible with the 
Workflows UI, thanks to <code>pydantic's</code> integration with the OpenAPI standard.</p>
</li>
<li>
<p><strong>Defines Data Bindings:</strong> It specifies which fields in the manifest are selectors for data flowing through 
the workflow during execution and indicates their kinds.</p>
</li>
<li>
<p><strong>Describes Block Outputs:</strong> It outlines the outputs that the block will produce.</p>
</li>
<li>
<p><strong>Specifies Dimensionality:</strong> It details the properties related to input and output dimensionality.</p>
</li>
<li>
<p><strong>Indicates Batch Inputs and Empty Values:</strong> It informs the Execution Engine whether the step accepts batch 
inputs and empty values.</p>
</li>
<li>
<p><strong>Ensures Compatibility:</strong> It dictates the compatibility with different Execution Engine versions to maintain 
stability. For more details, see <a href="/workflows/versioning/">versioning</a>.</p>
</li>
</ul>
<h3 id="scaffolding-for-manifest">Scaffolding for manifest<a class="headerlink" href="#scaffolding-for-manifest" title="Permanent link">¶</a></h3>
<p>To understand how manifests work, let's define one step-by-step. The example block that we build here will be 
calculating images similarity. We start from imports and class scaffolding:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<p>This is the minimal representation of a manifest. It defines two special fields that are important for 
Compiler and Execution engine:</p>
<ul>
<li>
<p><code>type</code> - required to parse syntax of Workflows definitions based on dynamic pool of blocks - this is the 
<a href="https://docs.pydantic.dev/latest/concepts/unions/#discriminated-unions"><code>pydantic</code> type discriminator</a> that lets the Compiler understand which block manifest is to be verified when 
parsing specific steps in a Workflow definition</p>
</li>
<li>
<p><code>name</code> - this property will be used to give the step a unique name and let other steps selects it via selectors</p>
</li>
</ul>
<h3 id="adding-batch-oriented-inputs">Adding batch-oriented inputs<a class="headerlink" href="#adding-batch-oriented-inputs" title="Permanent link">¶</a></h3>
<p>We want our step to take two batch-oriented inputs with images to be compared - so effectively
we will be creating SIMD block. </p>
<details class="example">
<summary>Adding batch-oriented inputs</summary>
<p>Let's see how to add definitions of those inputs to manifest: </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span>
<span class="hll"><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
</span><span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
</span><span class="hll">    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span>
<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># all properties apart from `type` and `name` are treated as either </span>
    <span class="c1"># definitions of batch-oriented data to be processed by block or its </span>
    <span class="c1"># parameters that influence execution of steps created based on block</span>
<span class="hll">    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span><span class="hll">    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in the lines <code>2-9</code>, we've added a couple of imports to ensure that we have everything needed</p>
</li>
<li>
<p>line <code>17</code> defines <code>image_1</code> parameter - as manifest is prototype for Workflow Definition, 
the only way to tell about image to be used by step is to provide selector - we have 
two specialised types in core library that can be used - <code>WorkflowImageSelector</code> and <code>StepOutputImageSelector</code>.
If you look deeper into codebase, you will discover those are type aliases - telling <code>pydantic</code>
to expect string matching <code>$inputs.{name}</code> and <code>$steps.{name}.*</code> patterns respectively, additionally providing 
extra schema field metadata that tells Workflows ecosystem components that the <code>kind</code> of data behind selector is 
<a href="/workflows/kinds/image/">image</a>.</p>
</li>
<li>
<p>denoting <code>pydantic</code> <code>Field(...)</code> attribute in the last parts of line <code>17</code> is optional, yet appreciated, 
especially for blocks intended to cooperate with Workflows UI </p>
</li>
<li>
<p>starting in line <code>20</code>, you can find definition of <code>image_2</code> parameter which is very similar to <code>image_1</code>.</p>
</li>
</ul>
</details>
<p>Such definition of manifest can handle the following step declaration in Workflow definition:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_step"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$inputs.my_image"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$steps.image_transformation.image"</span>
<span class="p">}</span>
</code></pre></div>
<p>This definition will make the Compiler and Execution Engine:</p>
<ul>
<li>
<p>select as a step prototype the block which declared manifest with type discriminator being 
<code>my_plugin/images_similarity@v1</code></p>
</li>
<li>
<p>supply two parameters for the steps run method:</p>
</li>
<li>
<p><code>input_1</code> of type <code>WorkflowImageData</code> which will be filled with image submitted as Workflow execution input</p>
</li>
<li>
<p><code>imput_2</code> of type <code>WorkflowImageData</code> which will be generated at runtime, by another step called 
  <code>image_transformation</code></p>
</li>
</ul>
<h3 id="adding-parameter-to-the-manifest">Adding parameter to the manifest<a class="headerlink" href="#adding-parameter-to-the-manifest" title="Permanent link">¶</a></h3>
<p>Let's now add the parameter that will influence step execution. The parameter is not assumed to be 
batch-oriented and will affect all batch elements passed to the step.</p>
<details class="example">
<summary>Adding parameter to the manifest</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="hll">    <span class="n">FloatZeroToOne</span><span class="p">,</span>
</span><span class="hll">    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
</span><span class="hll">    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># all properties apart from `type` and `name` are treated as either </span>
    <span class="c1"># definitions of batch-oriented data to be processed by block or its </span>
    <span class="c1"># parameters that influence execution of steps created based on block</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
<span class="hll">    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span class="hll">        <span class="n">FloatZeroToOne</span><span class="p">,</span>
</span><span class="hll">        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
</span><span class="hll">    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>line <code>9</code> imports <code>FloatZeroToOne</code> which is type alias providing validation 
for float values in range 0.0-1.0 - this is based on native <code>pydantic</code> mechanism and
everyone could create this type annotation locally in module hosting block</p>
</li>
<li>
<p>line <code>10</code> imports function <code>WorkflowParameterSelector(...)</code> capable to dynamically create 
<code>pydantic</code> type annotation for selector to workflow input parameter (matching format <code>$inputs.param_name</code>), 
declaring union of kinds compatible with the field</p>
</li>
<li>
<p>line <code>11</code> imports <a href="/workflows/kinds/float_zero_to_one"><code>float_zero_to_one</code></a> <code>kind</code> definition which will be used later</p>
</li>
<li>
<p>in line <code>26</code> we start defining parameter called <code>similarity_threshold</code>. Manifest will accept 
either float values (in range <code>[0.0-1.0]</code>) or selector to workflow input of <code>kind</code>
<a href="/workflows/kinds/float_zero_to_one"><code>float_zero_to_one</code></a>. Please point out on how 
function creating type annotation (<code>WorkflowParameterSelector(...)</code>) is used - 
in particular, expected <code>kind</code> of data is passed as list of <code>kinds</code> - representing union
of expected data <code>kinds</code>.</p>
</li>
</ul>
</details>
<p>Such definition of manifest can handle the following step declaration in Workflow definition:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_step"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$inputs.my_image"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$steps.image_transformation.image"</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">"similarity_threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$inputs.my_similarity_threshold"</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>or alternatively:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_step"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$inputs.my_image"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"image_2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$steps.image_transformation.image"</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">"similarity_threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.5"</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<details class="hint">
<summary>LEARN MORE: Selecting step outputs</summary>
<p>Our siplified example showcased declaration of properties that accept selectors to
images produced by other steps via <code>StepOutputImageSelector</code>.</p>
<p>You can use function <code>StepOutputSelector(...)</code> creating field annotations dynamically
to express the that block accepts batch-oriented outputs from other steps of specified
kinds</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="hll">    <span class="n">StepOutputSelector</span><span class="p">,</span>
</span><span class="hll">    <span class="n">NUMPY_ARRAY_KIND</span><span class="p">,</span>
</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># all properties apart from `type` and `name` are treated as either </span>
    <span class="c1"># definitions of batch-oriented data to be processed by block or its </span>
    <span class="c1"># parameters that influence execution of steps created based on block</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
<span class="hll">    <span class="n">example</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">NUMPY_ARRAY_KIND</span><span class="p">])</span>
</span></code></pre></div></td></tr></table></div>
</details>
<h3 id="declaring-block-outputs">Declaring block outputs<a class="headerlink" href="#declaring-block-outputs" title="Permanent link">¶</a></h3>
<p>Our manifest is ready regarding properties that can be declared in Workflow definitions, 
but we still need to provide additional information for the Execution Engine to successfully 
run the block.</p>
<details class="example">
<summary>Declaring block outputs</summary>
<p>Minimal set of information required is outputs description. Additionally, 
to increase block stability, we advise to provide information about execution engine 
compatibility.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="hll"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
</span><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="hll">    <span class="n">OutputDefinition</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">FloatZeroToOne</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
<span class="hll">    <span class="n">BOOLEAN_KIND</span><span class="p">,</span>
</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">FloatZeroToOne</span><span class="p">,</span>
        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">          <span class="n">OutputDefinition</span><span class="p">(</span>
</span><span class="hll">            <span class="n">name</span><span class="o">=</span><span class="s2">"images_match"</span><span class="p">,</span> 
</span><span class="hll">            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">BOOLEAN_KIND</span><span class="p">],</span>
</span><span class="hll">          <span class="p">)</span>
</span><span class="hll">        <span class="p">]</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>line <code>1</code> contains additional imports from <code>typing</code></p>
</li>
<li>
<p>line <code>5</code> imports class that is used to describe step outputs</p>
</li>
<li>
<p>line <code>13</code> imports <a href="/workflows/kinds/boolean"><code>boolean</code></a> <code>kind</code> to be used 
in outputs definitions</p>
</li>
<li>
<p>lines <code>33-40</code> declare class method to specify outputs from the block - 
each entry in list declare one return property for each batch element and its <code>kind</code>.
Our block will return boolean flag <code>images_match</code> for each pair of images.</p>
</li>
<li>
<p>lines <code>42-44</code> declare compatibility of the block with Execution Engine -
see <a href="/workflows/versioning/">versioning page</a> for more details</p>
</li>
</ul>
</details>
<p>As a result of those changes:</p>
<ul>
<li>
<p>Execution Engine would understand that steps created based on this block 
are supposed to deliver specified outputs and other steps can refer to those outputs
in their inputs</p>
</li>
<li>
<p>the blocks loading mechanism will not load the block given that Execution Engine is not in version <code>v1</code></p>
</li>
</ul>
<details class="hint">
<summary>LEARN MORE: Dynamic outputs</summary>
<p>Some blocks may not be able to arbitrailry define their outputs using 
classmethod - regardless of the content of step manifest that is available after 
parsing. To support this we introduced the following convention:</p>
<ul>
<li>
<p>classmethod <code>describe_outputs(...)</code> shall return list with one element of 
name <code>*</code> and kind <code>*</code> (aka <code>WILDCARD_KIND</code>)</p>
</li>
<li>
<p>additionally, block manifest should implement instance method <code>get_actual_outputs(...)</code>
that provides list of actual outputs that can be generated based on filled manifest data </p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">FloatZeroToOne</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
    <span class="n">BOOLEAN_KIND</span><span class="p">,</span>
<span class="hll">    <span class="n">WILDCARD_KIND</span><span class="p">,</span>
</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">FloatZeroToOne</span><span class="p">,</span>
        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">          <span class="n">OutputDefinition</span><span class="p">(</span>
</span><span class="hll">            <span class="n">name</span><span class="o">=</span><span class="s2">"*"</span><span class="p">,</span> 
</span><span class="hll">            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">WILDCARD_KIND</span><span class="p">],</span>
</span><span class="hll">          <span class="p">),</span>
</span><span class="hll">        <span class="p">]</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">get_actual_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
</span><span class="hll">        <span class="c1"># here you have access to `self`:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span>
</span><span class="hll">          <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">BOOLEAN_KIND</span><span class="p">])</span>
</span><span class="hll">          <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span>
</span><span class="hll">        <span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
</details>
<h2 id="definition-of-block-class">Definition of block class<a class="headerlink" href="#definition-of-block-class" title="Permanent link">¶</a></h2>
<p>At this stage, the manifest of our simple block is ready, we will continue 
with our example. You can check out the <a href="#advanced-topics">advanced topics</a> section for more details that would just 
be a distractions now.</p>
<h3 id="base-implementation">Base implementation<a class="headerlink" href="#base-implementation" title="Permanent link">¶</a></h3>
<p>Having the manifest ready, we can prepare baseline implementation of the 
block.</p>
<details class="example">
<summary>Block scaffolding</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="hll"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
</span><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="hll">    <span class="n">WorkflowBlock</span><span class="p">,</span>
</span><span class="hll">    <span class="n">BlockResult</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">OutputDefinition</span><span class="p">,</span>
</span><span class="hll">    <span class="n">WorkflowImageData</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">FloatZeroToOne</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
    <span class="n">BOOLEAN_KIND</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">FloatZeroToOne</span><span class="p">,</span>
        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="n">OutputDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"images_match"</span><span class="p">,</span> 
            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">BOOLEAN_KIND</span><span class="p">],</span>
          <span class="p">),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">ImagesSimilarityBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
<span class="hll">        <span class="k">return</span> <span class="n">ImagesSimilarityManifest</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span class="hll">        <span class="bp">self</span><span class="p">,</span>
</span><span class="hll">        <span class="n">image_1</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
</span><span class="hll">        <span class="n">image_2</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
</span><span class="hll">        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
</span><span class="hll">        <span class="k">pass</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>1</code>, <code>5-6</code> and <code>8-9</code> added changes into import surtucture to 
provide additional symbols required to properly define block class and all
of its methods signatures</p>
</li>
<li>
<p>line <code>59</code> defines class method <code>get_manifest(...)</code> to simply return 
the manifest class we cretaed earlier</p>
</li>
<li>
<p>lines <code>62-68</code> define <code>run(...)</code> function, which Execution Engine
will invoke with data to get desired results</p>
</li>
</ul>
</details>
<h3 id="providing-implementation-for-block-logic">Providing implementation for block logic<a class="headerlink" href="#providing-implementation-for-block-logic" title="Permanent link">¶</a></h3>
<p>Let's now add an example implementation of  the <code>run(...)</code> method to our block, such that
it can produce meaningful results.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Content of this section is supposed to provide examples on how to interact 
with the Workflow ecosystem as block creator, rather than providing robust 
implementation of the block.</p>
</div>
<details class="example">
<summary>Implementation of <code>run(...)</code> method</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="hll"><span class="kn">import</span> <span class="nn">cv2</span>
</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">BlockResult</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">FloatZeroToOne</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
    <span class="n">BOOLEAN_KIND</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">FloatZeroToOne</span><span class="p">,</span>
        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="n">OutputDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"images_match"</span><span class="p">,</span> 
            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">BOOLEAN_KIND</span><span class="p">],</span>
          <span class="p">),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">ImagesSimilarityBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trees</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">ImagesSimilarityManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_1</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
        <span class="n">image_2</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
<span class="hll">        <span class="n">image_1_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_1</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span><span class="hll">        <span class="n">image_2_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_2</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span><span class="hll">        <span class="n">kp_1</span><span class="p">,</span> <span class="n">des_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">image_1_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span class="hll">        <span class="n">kp_2</span><span class="p">,</span> <span class="n">des_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">image_2_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span class="hll">        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des_1</span><span class="p">,</span> <span class="n">des_2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span class="hll">        <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span class="hll">            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">similarity_threshold</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
</span><span class="hll">                <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">{</span>
</span><span class="hll">            <span class="s2">"images_match"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span class="hll">        <span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in line <code>3</code> we import OpenCV</p>
</li>
<li>
<p>lines <code>56-58</code> defines block constructor, thanks to this - state of block 
is initialised once and live through consecutive invocation of <code>run(...)</code> method - for 
instance when Execution Engine runs on consecutive frames of video</p>
</li>
<li>
<p>lines <code>70-81</code> provide implementation of block functionality - the details are trully not
important regarding Workflows ecosystem, but there are few details you should focus:</p>
<ul>
<li>
<p>lines <code>70</code> and <code>71</code> make use of <code>WorkflowImageData</code> abstraction, showcasing how 
<code>numpy_image</code> property can be used to get <code>np.ndarray</code> from internal representation of images
in Workflows. We advise to expole remaining properties of <code>WorkflowImageData</code> to discover more.</p>
</li>
<li>
<p>result of workflow block execution, declared in lines <code>79-81</code> is in our case just a dictionary 
<strong>with the keys being the names of outputs declared in manifest</strong>, in line <code>44</code>. Be sure to provide all
declared outputs - otherwise Execution Engine will raise error.</p>
</li>
</ul>
</li>
</ul>
</details>
<p>You may ask yourself how it is possible that implemented block accepts batch-oriented workflow input, but do not 
operate on batches directly. This is due to the fact that the default block behaviour is to run one-by-one against
all elements of input batches. We will show how to change that in <a href="#advanced-topics">advanced topics</a> section.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One important note: blocks, like all other classes, have constructors that may initialize a state. This state can 
persist across multiple Workflow runs when using the same instance of the Execution Engine. If the state management 
needs to be aware of which batch element it processes (e.g., in object tracking scenarios), the block creator 
should use dedicated batch-oriented inputs. These inputs, provide relevant metadatadata — like the 
<code>WorkflowVideoMetadata</code> input, which is crucial for tracking use cases and can be used along with <code>WorkflowImage</code> 
input in a block implementing tracker.</p>
<p>The ecosystem is evolving, and new input types will be introduced over time. If a specific input type needed for 
a use case is not available, an alternative is to design the block to process entire input batches. This way, 
you can rely on the Batch container's indices property, which provides an index for each batch element, allowing 
you to maintain the correct order of processing.</p>
</div>
<h2 id="exposing-block-in-plugin">Exposing block in <code>plugin</code><a class="headerlink" href="#exposing-block-in-plugin" title="Permanent link">¶</a></h2>
<p>Now, your block is ready to be used, but if you declared step using it in your Workflow definition you 
would see an error. This is because no plugin exports the block you just created. Details of blocks bundling 
will be covered in <a href="/workflows/blocks_bundling/">separate page</a>, but the remaining thing to do is to 
add block class into list returned from your plugins' <code>load_blocks(...)</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># __init__.py of your plugin</span>

<span class="kn">from</span> <span class="nn">my_plugin.images_similarity.v1</span> <span class="kn">import</span>  <span class="n">ImagesSimilarityBlock</span>  
<span class="c1"># this is example import! requires adjustment</span>

<span class="k">def</span> <span class="nf">load_blocks</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ImagesSimilarityBlock</span><span class="p">]</span>
</code></pre></div>
<h2 id="advanced-topics">Advanced topics<a class="headerlink" href="#advanced-topics" title="Permanent link">¶</a></h2>
<h3 id="blocks-processing-batches-of-inputs">Blocks processing batches of inputs<a class="headerlink" href="#blocks-processing-batches-of-inputs" title="Permanent link">¶</a></h3>
<p>Sometimes, performance of your block may benefit if all input data is processed at once as batch. This may
happen for models running on GPU. Such mode of operation is supported for Workflows blocks - here is the example
on how to use it for your block.</p>
<details class="example">
<summary>Implementation of blocks accepting batches</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">BlockResult</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="hll">    <span class="n">Batch</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">FloatZeroToOne</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
    <span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">,</span>
    <span class="n">BOOLEAN_KIND</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">ImagesSimilarityManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/images_similarity@v1"</span><span class="p">]</span> 
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">image_1</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"First image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">image_2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Second image to calculate similarity"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">FloatZeroToOne</span><span class="p">,</span>
        <span class="n">WorkflowParameterSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">FLOAT_ZERO_TO_ONE_KIND</span><span class="p">]),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">"Threshold to assume that images are similar"</span><span class="p">,</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">accepts_batch_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="n">OutputDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"images_match"</span><span class="p">,</span> 
            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">BOOLEAN_KIND</span><span class="p">],</span>
          <span class="p">),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">ImagesSimilarityBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trees</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="o">=</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">ImagesSimilarityManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">image_1</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">],</span>
</span><span class="hll">        <span class="n">image_2</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">],</span>
</span>        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
<span class="hll">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">image_1_element</span><span class="p">,</span> <span class="n">image_2_element</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_1</span><span class="p">,</span> <span class="n">image_2</span><span class="p">):</span> 
</span><span class="hll">          <span class="n">image_1_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_1_element</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span><span class="hll">          <span class="n">image_2_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_2_element</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</span>          <span class="n">kp_1</span><span class="p">,</span> <span class="n">des_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">image_1_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
          <span class="n">kp_2</span><span class="p">,</span> <span class="n">des_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">image_2_gray</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
          <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matcher</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des_1</span><span class="p">,</span> <span class="n">des_2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">similarity_threshold</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
                  <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="hll">          <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"images_match"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">})</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>line <code>13</code> imports <code>Batch</code> from core of workflows library - this class represent container which is 
veri similar to list (but read-only) to keep batch elements</p>
</li>
<li>
<p>lines <code>41-43</code> define class method that changes default behaviour of the block and make it capable 
to process batches</p>
</li>
<li>
<p>changes introduced above made the signature of <code>run(...)</code> method to change, now <code>image_1</code> and <code>image_2</code>
are not instances of <code>WorkflowImageData</code>, but rather batches of elements of this type</p>
</li>
<li>
<p>lines <code>75-78</code>, <code>86-87</code> present changes that needed to be introduced to run processing across all batch 
elements - showcasing how to iterate over batch elements if needed</p>
</li>
<li>
<p>it is important to note how outputs are constructed in line <code>86</code> - each element of batch will be given
its entry in the list which is returned from <code>run(...)</code> method. Order must be aligned with order of batch 
elements. Each output dictionary must provide all keys declared in block outputs.</p>
</li>
</ul>
</details>
<h3 id="implementation-of-flow-control-block">Implementation of flow-control block<a class="headerlink" href="#implementation-of-flow-control-block" title="Permanent link">¶</a></h3>
<p>Flow-control blocks differs quite substantially from other blocks that just process the data. Here we will show 
how to create a flow control block, but first - a little bit of theory:</p>
<ul>
<li>
<p>flow-control block is the block that declares compatibility with step selectors in their manifest (selector to step
is defined as <code>$steps.{step_name}</code> - similar to step output selector, but without specification of output name)</p>
</li>
<li>
<p>flow-control blocks cannot register outputs, they are meant to return <code>FlowControl</code> objects</p>
</li>
<li>
<p><code>FlowControl</code> object specify next steps (from selectors provided in step manifest) that for given 
batch element (SIMD flow-control) or whole workflow execution (non-SIMD flow-control) should pick up next</p>
</li>
</ul>
<details class="example">
<summary>Implementation of flow-control - SIMD block</summary>
<p>Example provides and comments out implementation of random continue block</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
  <span class="n">OutputDefinition</span><span class="p">,</span>
  <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
<span class="hll">    <span class="n">StepSelector</span><span class="p">,</span>
</span>    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.v1.entities</span> <span class="kn">import</span> <span class="n">FlowControl</span>
</span><span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>



<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/random_continue@v1"</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="hll">    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageInputField</span>
</span>    <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span>
<span class="hll">    <span class="n">next_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StepSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Reference to step which shall be executed if expression evaluates to true"</span><span class="p">,</span>
</span><span class="hll">        <span class="n">examples</span><span class="o">=</span><span class="p">[[</span><span class="s2">"$steps.on_true"</span><span class="p">]],</span>
</span><span class="hll">    <span class="p">)</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">RandomContinueBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
        <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">next_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_steps</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">probability</span><span class="p">:</span>
<span class="hll">            <span class="k">return</span> <span class="n">FlowControl</span><span class="p">()</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">FlowControl</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">next_steps</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>line <code>10</code> imports type annotation for step selector which will be used to 
notify Execution Engine that the block controls the flow</p>
</li>
<li>
<p>line <code>14</code> imports <code>FlowControl</code> class which is the only viable response from
flow-control block</p>
</li>
<li>
<p>line <code>26</code> specifies <code>image</code> which is batch-oriented input making the block SIMD - 
which means that for each element of images batch, block will make random choice on 
flow-control - if not that input block would operate in non-SIMD mode</p>
</li>
<li>
<p>line <code>28</code> defines list of step selectors <strong>which effectively turns the block into flow-control one</strong></p>
</li>
<li>
<p>lines <code>55</code> and <code>56</code> show how to construct output - <code>FlowControl</code> object accept context being <code>None</code>, <code>string</code> or 
<code>list of strings</code> - <code>None</code> represent flow termination for the batch element, strings are expected to be selectors 
for next steps, passed in input.</p>
</li>
</ul>
</details>
<details class="example">
<summary>Implementation of flow-control non-SIMD block</summary>
<p>Example provides and comments out implementation of random continue block</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
  <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
<span class="hll">    <span class="n">StepSelector</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.v1.entities</span> <span class="kn">import</span> <span class="n">FlowControl</span>
</span><span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>



<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/random_continue@v1"</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span>
<span class="hll">    <span class="n">next_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StepSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Reference to step which shall be executed if expression evaluates to true"</span><span class="p">,</span>
</span><span class="hll">        <span class="n">examples</span><span class="o">=</span><span class="p">[[</span><span class="s2">"$steps.on_true"</span><span class="p">]],</span>
</span><span class="hll">    <span class="p">)</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">RandomContinueBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">next_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_steps</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">probability</span><span class="p">:</span>
<span class="hll">            <span class="k">return</span> <span class="n">FlowControl</span><span class="p">()</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">FlowControl</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">next_steps</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>line <code>9</code> imports type annotation for step selector which will be used to 
notify Execution Engine that the block controls the flow</p>
</li>
<li>
<p>line <code>11</code> imports <code>FlowControl</code> class which is the only viable response from
flow-control block</p>
</li>
<li>
<p>lines <code>24-27</code> defines list of step selectors <strong>which effectively turns the block into flow-control one</strong></p>
</li>
<li>
<p>lines <code>50</code> and <code>51</code> show how to construct output - <code>FlowControl</code> object accept context being <code>None</code>, <code>string</code> or 
<code>list of strings</code> - <code>None</code> represent flow termination for the batch element, strings are expected to be selectors 
for next steps, passed in input.</p>
</li>
</ul>
</details>
<h3 id="nested-selectors">Nested selectors<a class="headerlink" href="#nested-selectors" title="Permanent link">¶</a></h3>
<p>Some block will require list of selectors or dictionary of selectors to be 
provided in block manifest field. Version <code>v1</code> of Execution Engine supports only 
one level of nesting - so list of lists of selectors or dictionary with list of selectors 
will not be recognised properly.</p>
<p>Practical use cases showcasing usage of nested selectors are presented below.</p>
<h4 id="fusion-of-predictions-from-variable-number-of-models">Fusion of predictions from variable number of models<a class="headerlink" href="#fusion-of-predictions-from-variable-number-of-models" title="Permanent link">¶</a></h4>
<p>Let's assume that you want to build a block to get majority vote on multiple classifiers predictions - then you would 
like your run method to look like that:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pseud-code here</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
    <span class="n">predicted_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">"class"</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">predicted_classes</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">"top_class"</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
</code></pre></div>
<details class="example">
<summary>Nested selectors - models ensemble</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
  <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>



<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/fusion_of_predictions@v1"</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="hll">    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StepOutputSelector</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">])]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Selectors to step outputs"</span><span class="p">,</span>
</span><span class="hll">        <span class="n">examples</span><span class="o">=</span><span class="p">[[</span><span class="s2">"$steps.model_1.predictions"</span><span class="p">,</span> <span class="s2">"$steps.model_2.predictions"</span><span class="p">]],</span>
</span><span class="hll">    <span class="p">)</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="n">OutputDefinition</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">"predictions"</span><span class="p">,</span> 
            <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">],</span>
          <span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">FusionBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"predictions"</span><span class="p">:</span> <span class="n">merged</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>23-26</code> depict how to define manifest field capable of accepting 
list of selectors</p>
</li>
<li>
<p>line <code>50</code> shows what to expect as input to block's <code>run(...)</code> method - 
list of objects which are representation of specific kind. If the block accepted 
batches, the input type of <code>predictions</code> field would be <code>List[Batch[sv.Detections]</code></p>
</li>
</ul>
</details>
<p>Such block is compatible with the following step declaration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_plugin/fusion_of_predictions@v1"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_step"</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">"predictions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span class="hll"><span class="w">    </span><span class="s2">"$steps.model_1.predictions"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="s2">"$steps.model_2.predictions"</span><span class="w">  </span>
</span><span class="hll"><span class="w">  </span><span class="p">]</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="block-with-data-transformations-allowing-dynamic-parameters">Block with data transformations allowing dynamic parameters<a class="headerlink" href="#block-with-data-transformations-allowing-dynamic-parameters" title="Permanent link">¶</a></h4>
<p>Occasionally, blocks may need to accept group of "named" selectors, 
which names and values are to be defined by creator of Workflow definition. 
In such cases, block manifest shall accept dictionary of selectors, where
keys serve as names for those selectors.</p>
<details class="example">
<summary>Nested selectors - named selectors</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
  <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowParameterSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>



<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/named_selectors_example@v1"</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<span class="hll">    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">StepOutputSelector</span><span class="p">(),</span> <span class="n">WorkflowParameterSelector</span><span class="p">()]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span class="hll">        <span class="n">description</span><span class="o">=</span><span class="s2">"Selectors to step outputs"</span><span class="p">,</span>
</span><span class="hll">        <span class="n">examples</span><span class="o">=</span><span class="p">[{</span><span class="s2">"a"</span><span class="p">:</span> <span class="err">$</span><span class="n">steps</span><span class="o">.</span><span class="n">model_1</span><span class="o">.</span><span class="n">predictions</span><span class="s2">", "</span><span class="sa">b</span><span class="s2">": "</span><span class="err">$</span><span class="n">Inputs</span><span class="o">.</span><span class="n">data</span><span class="s2">"}],</span>
</span><span class="hll">    <span class="p">)</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
          <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"my_output"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[]),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">BlockWithNamedSelectorsV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"my_output"</span><span class="p">:</span> <span class="o">...</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>23-26</code> depict how to define manifest field capable of accepting 
list of selectors</p>
</li>
<li>
<p>line <code>47</code> shows what to expect as input to block's <code>run(...)</code> method - 
dict of objects which are reffered with selectors. If the block accepted 
batches, the input type of <code>data</code> field would be <code>Dict[str, Union[Batch[Any], Any]]</code>.
In non-batch cases, non-batch-oriented data referenced by selector is automatically 
broadcasted, whereas for blocks accepting batches - <code>Batch</code> container wraps only 
batch-oriented inputs, with other inputs being passed as singular values.</p>
</li>
</ul>
</details>
<p>Such block is compatible with the following step declaration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_plugin/named_selectors_example@v1"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my_step"</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"a"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$steps.model_1.predictions"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nt">"b"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$inputs.my_parameter"</span><span class="w">  </span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Practical implications will be the following:</p>
<ul>
<li>
<p>under <code>data["a"]</code> inside <code>run(...)</code> you will be able to find model's predictions - 
like <code>sv.Detections</code> if <code>model_1</code> is object-detection model</p>
</li>
<li>
<p>under <code>data["b"]</code> inside <code>run(...)</code>, you will find value of input parameter named <code>my_parameter</code></p>
</li>
</ul>
<h3 id="inputs-and-output-dimensionality-vs-run-method">Inputs and output dimensionality vs <code>run(...)</code> method<a class="headerlink" href="#inputs-and-output-dimensionality-vs-run-method" title="Permanent link">¶</a></h3>
<p>The dimensionality of block inputs plays a crucial role in shaping the <code>run(...)</code> method’s signature, and that's 
why the system enforces strict bounds on the differences in dimensionality levels between inputs 
(with the maximum allowed difference being <code>1</code>). This restriction is critical for ensuring consistency and 
predictability when writing blocks.</p>
<p>If dimensionality differences weren't controlled, it would be difficult to predict the structure of 
the <code>run(...)</code> method, making development harder and less reliable. That’s why validation of this property 
is strictly enforced during the Workflow compilation process.</p>
<p>Similarly, the output dimensionality also affects the method signature and the format of the expected output. 
The ecosystem supports the following scenarios:</p>
<ul>
<li>
<p>all inputs have <strong>the same dimensionality</strong> and outputs <strong>does not change</strong> dimensionality - baseline case</p>
</li>
<li>
<p>all inputs have <strong>the same dimensionality</strong> and output <strong>decreases</strong> dimensionality</p>
</li>
<li>
<p>all inputs have <strong>the same dimensionality</strong> and output <strong>increases</strong> dimensionality</p>
</li>
<li>
<p>inputs have <strong>different dimensionality</strong> and output is allowed to keep the dimensionality of 
<strong>reference input</strong></p>
</li>
</ul>
<p>Other combinations of input/output dimensionalities are not allowed to ensure consistency and to prevent ambiguity in 
the method signatures.</p>
<details class="example">
<summary>Impact of dimensionality on <code>run(...)</code> method - batches disabled</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">output dimensionality increase</label><label for="__tabbed_1_2">output dimensionality decrease</label><label for="__tabbed_1_3">different input dimensionalities</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>In this example, we perform dynamic crop of image based on predictions.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.constants</span> <span class="kn">import</span> <span class="n">DETECTION_ID_KEY</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
    <span class="n">ImageParentMetadata</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IMAGE_KIND</span><span class="p">,</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_block/dynamic_crop@v1"</span><span class="p">]</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">],</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_output_dimensionality_offset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="mi">1</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"crops"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">IMAGE_KIND</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>

<span class="k">class</span> <span class="nc">DynamicCropBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
        <span class="n">predictions</span><span class="p">:</span> <span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">crops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="ow">in</span> <span class="n">predictions</span><span class="o">.</span><span class="n">xyxy</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
            <span class="n">parent_metadata</span> <span class="o">=</span> <span class="n">ImageParentMetadata</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">WorkflowImageData</span><span class="p">(</span>
                    <span class="n">parent_metadata</span><span class="o">=</span><span class="n">parent_metadata</span><span class="p">,</span>
                    <span class="n">numpy_image</span><span class="o">=</span><span class="n">cropped_image</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
<span class="hll">                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
</span><span class="hll">            <span class="n">crops</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"crops"</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">crops</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in lines <code>30-32</code> manifest class declares output dimensionality 
offset - value <code>1</code> should be understood as adding <code>1</code> to dimensionality level</p>
</li>
<li>
<p>point out, that in line <code>65</code>, block eliminates empty images from further processing but 
placing <code>None</code> instead of dictionatry with outputs. This would utilise the same 
Execution Engine behaviour that is used for conditional execution - datapoint will
be eliminated from downstream processing (unless steps requesting empty inputs 
are present down the line).</p>
</li>
<li>
<p>in lines <code>66-67</code> results for single input <code>image</code> and <code>predictions</code> are collected - 
it is meant to be list of dictionares containing all registered outputs as keys. Execution
engine will understand that the step returns batch of elements for each input element and
create nested sturcures of indices to keep track of during execution of downstream steps.</p>
</li>
</ul>
</div>
<div class="tabbed-block">
<p>In this example, the block visualises crops predictions and creates tiles
presenting all crops predictions in single output image.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IMAGE_KIND</span><span class="p">,</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/tile_detections@v1"</span><span class="p">]</span>
    <span class="n">crops</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">crops_predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">]</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_output_dimensionality_offset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"visualisations"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">IMAGE_KIND</span><span class="p">]),</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TileDetectionsBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">crops</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">],</span>
</span><span class="hll">        <span class="n">crops_predictions</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">BoundingBoxAnnotator</span><span class="p">()</span>
        <span class="n">visualisations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">crops</span><span class="p">,</span> <span class="n">crops_predictions</span><span class="p">):</span>
            <span class="n">annotated_image</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">image</span><span class="o">.</span><span class="n">numpy_image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">prediction</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">visualisations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotated_image</span><span class="p">)</span>
<span class="hll">        <span class="n">tile</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">create_tiles</span><span class="p">(</span><span class="n">visualisations</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">{</span><span class="s2">"visualisations"</span><span class="p">:</span> <span class="n">tile</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in lines <code>31-33</code> manifest class declares output dimensionality 
offset - value <code>-1</code> should be understood as decreasing dimensionality level by <code>1</code></p>
</li>
<li>
<p>in lines <code>50-51</code> you can see the impact of output dimensionality decrease
on the method signature. Both inputs are artificially wrapped in <code>Batch[]</code> container.
This is done by Execution Engine automatically on output dimensionality decrease when 
all inputs have the same dimensionality to enable access to all elements occupying 
the last dimensionality level. Obviously, only elements related to the same element 
from top-level batch will be grouped. For instance, if you had two input images that you 
cropped - crops from those two different images will be grouped separately.</p>
</li>
<li>
<p>lines <code>61-62</code> illustrate how output is constructed - single value is returned and that value 
will be indexed by Execution Engine in output batch with reduced dimensionality</p>
</li>
</ul>
</div>
<div class="tabbed-block">
<p>In this example, block merges detections which were predicted based on 
crops of original image - result is to provide single detections with 
all partial ones being merged.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/stitch@v1"</span><span class="p">]</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">image_predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">],</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_input_dimensionality_offsets</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">{</span>
</span><span class="hll">            <span class="s2">"image"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class="hll">            <span class="s2">"image_predictions"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="hll">        <span class="p">}</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_dimensionality_reference_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="s2">"image"</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"predictions"</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">),</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">StitchDetectionsNonBatchBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">image</span><span class="p">:</span> <span class="n">WorkflowImageData</span><span class="p">,</span>
</span><span class="hll">        <span class="n">image_predictions</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">image_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_predictions</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_predictions</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">"parent_coordinates"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p</span><span class="o">.</span><span class="n">xyxy</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">))</span>
<span class="hll">        <span class="k">return</span> <span class="p">{</span><span class="s2">"predictions"</span><span class="p">:</span> <span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">image_predictions</span><span class="p">)}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in lines <code>32-37</code> manifest class declares input dimensionalities offset, indicating
<code>image</code> parameter being top-level and <code>image_predictions</code> being nested batch of predictions</p>
</li>
<li>
<p>whenever different input dimensionalities are declared, dimensionality reference property
must be pointed (see lines <code>39-41</code>) - this dimensionality level would be used to calculate 
output dimensionality - in this particular case, we specify <code>image</code>. This choice 
has an implication in the expected format of result - in the chosen scenario we are supposed
to return single dictionary with all registered outputs keys. If our choice is <code>image_predictions</code>,
we would return list of dictionaries (of size equal to length of <code>image_predictions</code> batch). In other worlds,
<code>get_dimensionality_reference_property(...)</code> which dimensionality level should be associated
to the output.</p>
</li>
<li>
<p>lines <code>63-64</code> present impact of dimensionality offsets specified in lines <code>32-37</code>. It is clearly
visible that <code>image_predictions</code> is a nested batch regarding <code>image</code>. Obviously, only nested predictions
relevant for the specific <code>images</code> are grouped in batch and provided to the method in runtime.</p>
</li>
<li>
<p>as mentioned earlier, line <code>70</code> construct output being single dictionary, as we register output 
at dimensionality level of <code>image</code> (which was also shipped as single element)</p>
</li>
</ul>
</div>
</div>
</input></input></input></div>
</details>
<details class="example">
<summary>Impact of dimensionality on <code>run(...)</code> method - batches enabled</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio"><input id="__tabbed_2_2" name="__tabbed_2" type="radio"><input id="__tabbed_2_3" name="__tabbed_2" type="radio"><div class="tabbed-labels"><label for="__tabbed_2_1">output dimensionality increase</label><label for="__tabbed_2_2">output dimensionality decrease</label><label for="__tabbed_2_3">different input dimensionalities</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>In this example, we perform dynamic crop of image based on predictions.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.constants</span> <span class="kn">import</span> <span class="n">DETECTION_ID_KEY</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
    <span class="n">ImageParentMetadata</span><span class="p">,</span>
    <span class="n">Batch</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IMAGE_KIND</span><span class="p">,</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_block/dynamic_crop@v1"</span><span class="p">]</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">],</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">accepts_batch_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_output_dimensionality_offset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="mi">1</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"crops"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">IMAGE_KIND</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>

<span class="k">class</span> <span class="nc">DynamicCropBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">image</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">],</span>
</span><span class="hll">        <span class="n">predictions</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">single_image</span><span class="p">,</span> <span class="n">detections</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
            <span class="n">crops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="ow">in</span> <span class="n">detections</span><span class="o">.</span><span class="n">xyxy</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>
                <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">single_image</span><span class="o">.</span><span class="n">numpy_image</span><span class="p">[</span><span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">]</span>
                <span class="n">parent_metadata</span> <span class="o">=</span> <span class="n">ImageParentMetadata</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cropped_image</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">WorkflowImageData</span><span class="p">(</span>
                        <span class="n">parent_metadata</span><span class="o">=</span><span class="n">parent_metadata</span><span class="p">,</span>
                        <span class="n">numpy_image</span><span class="o">=</span><span class="n">cropped_image</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
<span class="hll">                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
</span><span class="hll">                <span class="n">crops</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"crops"</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
</span><span class="hll">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crops</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">results</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in lines <code>31-33</code> manifest declares that block accepts batches of inputs</p>
</li>
<li>
<p>in lines <code>35-37</code> manifest class declares output dimensionality 
offset - value <code>1</code> should be understood as adding <code>1</code> to dimensionality level</p>
</li>
<li>
<p>in lines <code>57-68</code>, signature of input parameters reflects that the <code>run(...)</code> method
runs against inputs of the same dimensionality and those inputs are provided in batches</p>
</li>
<li>
<p>point out, that in line <code>72</code>, block eliminates empty images from further processing but 
placing <code>None</code> instead of dictionatry with outputs. This would utilise the same 
Execution Engine behaviour that is used for conditional execution - datapoint will
be eliminated from downstream processing (unless steps requesting empty inputs 
are present down the line).</p>
</li>
<li>
<p>construction of the output, presented in lines <code>73-75</code> indicates two levels of nesting.
First of all, block operates on batches, so it is expected to return list of outputs, one 
output for each input batch element. Additionally, this output element for each input batch 
element turns out to be nested batch - hence for each input iage and prediction, block 
generates list of outputs - elements of that list are dictionaries providing values 
for each declared output.</p>
</li>
</ul>
</div>
<div class="tabbed-block">
<p>In this example, the block visualises crops predictions and creates tiles
presenting all crops predictions in single output image.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IMAGE_KIND</span><span class="p">,</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/tile_detections@v1"</span><span class="p">]</span>
    <span class="n">images_crops</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">crops_predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">]</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">accepts_batch_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_output_dimensionality_offset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"visualisations"</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">IMAGE_KIND</span><span class="p">]),</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TileDetectionsBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">images_crops</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">]],</span>
</span><span class="hll">        <span class="n">crops_predictions</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">Batch</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">]],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">annotator</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">BoundingBoxAnnotator</span><span class="p">()</span>
        <span class="n">visualisations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image_crops</span><span class="p">,</span> <span class="n">crop_predictions</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images_crops</span><span class="p">,</span> <span class="n">crops_predictions</span><span class="p">):</span>
            <span class="n">visualisations_batch_element</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_crops</span><span class="p">,</span> <span class="n">crop_predictions</span><span class="p">):</span>
                <span class="n">annotated_image</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">numpy_image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">prediction</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">visualisations_batch_element</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotated_image</span><span class="p">)</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">create_tiles</span><span class="p">(</span><span class="n">visualisations_batch_element</span><span class="p">)</span>
<span class="hll">            <span class="n">visualisations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"visualisations"</span><span class="p">:</span> <span class="n">tile</span><span class="p">})</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">visualisations</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>31-33</code> manifest that block is expected to take batches as input</p>
</li>
<li>
<p>in lines <code>35-37</code> manifest class declares output dimensionality 
offset - value <code>-1</code> should be understood as decreasing dimensionality level by <code>1</code></p>
</li>
<li>
<p>in lines <code>54-55</code> you can see the impact of output dimensionality decrease
and batch processing on the method signature. First "layer" of <code>Batch[]</code> is a side effect of the 
fact that manifest declared that block accepts batches of inputs. The second "layer" comes 
from output dimensionality decrease. Execution Engine wrapps up the dimension to be reduced into 
additional <code>Batch[]</code> container porvided in inputs, such that programmer is able to collect all nested
batches elements that belong to specific top-level batch element.</p>
</li>
<li>
<p>lines <code>68-69</code> illustrate how output is constructed - for each top-level batch element, block
aggregates all crops and predictions and creates a single tile. As block accepts batches of inputs,
this procedure end up with one tile for each top-level batch element - hence list of dictionaries
is expected to be returned.</p>
</li>
</ul>
</div>
<div class="tabbed-block">
<p>In this example, block merges detections which were predicted based on 
crops of original image - result is to provide single detections with 
all partial ones being merged.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">supervision</span> <span class="k">as</span> <span class="nn">sv</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
    <span class="n">WorkflowImageData</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
    <span class="n">StepOutputImageSelector</span><span class="p">,</span>
    <span class="n">StepOutputSelector</span><span class="p">,</span>
    <span class="n">WorkflowImageSelector</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/stitch@v1"</span><span class="p">]</span>
    <span class="n">images</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">WorkflowImageSelector</span><span class="p">,</span> <span class="n">StepOutputImageSelector</span><span class="p">]</span>
    <span class="n">images_predictions</span><span class="p">:</span> <span class="n">StepOutputSelector</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="p">[</span><span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">],</span>
    <span class="p">)</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">accepts_batch_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_input_dimensionality_offsets</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">{</span>
</span><span class="hll">            <span class="s2">"image"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class="hll">            <span class="s2">"image_predictions"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class="hll">        <span class="p">}</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_dimensionality_reference_property</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="s2">"image"</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">OutputDefinition</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"predictions"</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">OBJECT_DETECTION_PREDICTION_KIND</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">),</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">StitchDetectionsBatchBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">images</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">WorkflowImageData</span><span class="p">],</span>
</span><span class="hll">        <span class="n">images_predictions</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">Batch</span><span class="p">[</span><span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="p">]],</span>
</span>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">image_predictions</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">images_predictions</span><span class="p">):</span>
            <span class="n">image_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_predictions</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">image_predictions</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">"parent_coordinates"</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">p</span><span class="o">.</span><span class="n">xyxy</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">coords</span><span class="p">,</span> <span class="n">coords</span><span class="p">))</span>
            <span class="n">merged_prediction</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">Detections</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">image_predictions</span><span class="p">)</span>
<span class="hll">            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"predictions"</span><span class="p">:</span> <span class="n">merged_prediction</span><span class="p">})</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>32-34</code> manifest that block is expected to take batches as input</p>
</li>
<li>
<p>in lines <code>36-41</code> manifest class declares input dimensionalities offset, indicating
<code>image</code> parameter being top-level and <code>image_predictions</code> being nested batch of predictions</p>
</li>
<li>
<p>whenever different input dimensionalities are declared, dimensionality reference property
must be pointed (see lines <code>43-45</code>) - this dimensionality level would be used to calculate 
output dimensionality - in this particular case, we specify <code>image</code>. This choice 
has an implication in the expected format of result - in the chosen scenario we are supposed
to return single dictionary for each element of <code>image</code> batch. If our choice is <code>image_predictions</code>,
we would return list of dictionaries (of size equal to length of nested <code>image_predictions</code> batch) for each
input <code>image</code> batch element.</p>
</li>
<li>
<p>lines <code>67-68</code> present impact of dimensionality offsets specified in lines <code>36-41</code> as well as 
the declararion of batch processing from lines <code>32-34</code>. First "layer" of <code>Batch[]</code> container comes 
from the latter, nested <code>Batch[Batch[]]</code> for <code>images_predictions</code> comes from the definition of input 
dimensionality offset. It is clearly visible that <code>image_predictions</code> holds batch of predictions relevant
for specific elements of <code>image</code> batch.</p>
</li>
<li>
<p>as mentioned earlier, lines <code>77-78</code> construct output being single dictionary for each element of <code>image</code> 
batch</p>
</li>
</ul>
</div>
</div>
</input></input></input></div>
</details>
<h3 id="block-accepting-empty-inputs">Block accepting empty inputs<a class="headerlink" href="#block-accepting-empty-inputs" title="Permanent link">¶</a></h3>
<p>As discussed earlier, some batch elements may become "empty" during the execution of a Workflow. 
This can happen due to several factors:</p>
<ul>
<li>
<p><strong>Flow-control mechanisms:</strong> Certain branches of execution can mask specific batch elements, preventing them 
from being processed in subsequent steps.</p>
</li>
<li>
<p><strong>In data-processing blocks:</strong> In some cases, a block may not be able to produce a meaningful output for 
a specific data point. For example, a Dynamic Crop block cannot generate a cropped image if the bounding box 
size is zero.</p>
</li>
</ul>
<p>Some blocks are designed to handle these empty inputs, such as block that can replace missing outputs with default 
values. This block can be particularly useful when constructing structured outputs in a Workflow, ensuring 
that even if some elements are empty, the output lacks missing elements making it harder to parse.</p>
<details class="example">
<summary>Block accepting empty inputs</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="n">StepOutputSelector</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/first_non_empty_or_default@v1"</span><span class="p">]</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StepOutputSelector</span><span class="p">()]</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Any</span>

<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">accepts_empty_values</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"output"</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">FirstNonEmptyOrDefaultBlockV1</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="hll">        <span class="n">data</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span>        <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">for</span> <span class="n">data_element</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">"output"</span><span class="p">:</span> <span class="n">data_element</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"output"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>in lines <code>20-22</code> you may find declaration stating that block acccepts empt inputs </p>
</li>
<li>
<p>a consequence of lines <code>20-22</code> is visible in line <code>41</code>, when signature states that 
input <code>Batch</code> may contain empty elements that needs to be handled. In fact - the block 
generates "artificial" output substituting empty value, which makes it possible for 
those outputs to be "visible" for blocks not accepting empty inputs that refer to the 
output of this block. You should assume that each input that is substituted by Execution
Engine with data generated in runtime may provide optional elements.</p>
</li>
</ul>
</details>
<h3 id="block-with-custom-constructor-parameters">Block with custom constructor parameters<a class="headerlink" href="#block-with-custom-constructor-parameters" title="Permanent link">¶</a></h3>
<p>Some blocks may require objects constructed by outside world to work. In such
scenario, Workflows Execution Engine job is to transfer those entities to the block, 
making it possible to be used. The mechanism is described in 
<a href="/workflows/workflows_compiler/">the page presenting Workflows Compiler</a>, as this is the 
component responsible for dynamic construction of steps from blocks classes.</p>
<p>Constructor parameters must be:</p>
<ul>
<li>
<p>requested by block - using class method <code>WorkflowBlock.get_init_parameters(...)</code></p>
</li>
<li>
<p>provided in the environment running Workflows Execution Engine:</p>
<ul>
<li>
<p>directly, as shown in <a href="/workflows/modes_of_running/#workflows-in-python-package">this</a> example</p>
</li>
<li>
<p>using defaults <a href="/workflows/blocks_bundling">registered for Workflow plugin</a></p>
</li>
</ul>
</li>
</ul>
<p>Let's see how to request init parameters while defining block.</p>
<details class="example">
<summary>Block requesting constructor parameters</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Batch</span><span class="p">,</span>
    <span class="n">OutputDefinition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.execution_engine.entities.types</span> <span class="kn">import</span> <span class="n">StepOutputSelector</span>
<span class="kn">from</span> <span class="nn">inference.core.workflows.prototypes.block</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BlockResult</span><span class="p">,</span>
    <span class="n">WorkflowBlock</span><span class="p">,</span>
    <span class="n">WorkflowBlockManifest</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">BlockManifest</span><span class="p">(</span><span class="n">WorkflowBlockManifest</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"my_plugin/example@v1"</span><span class="p">]</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StepOutputSelector</span><span class="p">()]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe_outputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OutputDefinition</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">OutputDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"output"</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_execution_engine_compatibility</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"&gt;=1.0.0,&lt;2.0.0"</span>


<span class="k">class</span> <span class="nc">ExampleBlock</span><span class="p">(</span><span class="n">WorkflowBlock</span><span class="p">):</span>

<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">my_parameter</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_my_parameter</span> <span class="o">=</span> <span class="n">my_parameter</span>
</span>
<span class="hll">    <span class="nd">@classmethod</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">get_init_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span class="hll">        <span class="k">return</span> <span class="p">[</span><span class="s2">"my_parameter"</span><span class="p">]</span>
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manifest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">WorkflowBlockManifest</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">BlockManifest</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Batch</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockResult</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>
<p>lines <code>30-31</code> declare class constructor which is not parameter-free</p>
</li>
<li>
<p>to inform Execution Engine that block requires custom initialisation, 
<code>get_init_parameters(...)</code> method in lines <code>33-35</code> enlists names of all 
parameters that must be provided</p>
</li>
</ul>
</details>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Kinds" class="md-footer__link md-footer__link--prev" href="../kinds/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                Previous
              </span>
<div class="md-ellipsis">
                Kinds
              </div>
</div>
</a>
<a aria-label="Next: Data Representations" class="md-footer__link md-footer__link--next" href="../internal_data_types/">
<div class="md-footer__title">
<span class="md-footer__direction">
                Next
              </span>
<div class="md-ellipsis">
                Data Representations
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Roboflow 2024. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/roboflow" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-social__link" href="https://www.youtube.com/roboflow" rel="noopener" target="_blank" title="www.youtube.com">
<svg viewbox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg>
</a>
<a class="md-social__link" href="https://www.linkedin.com/company/roboflow-ai/mycompany/" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
</a>
<a class="md-social__link" href="https://twitter.com/roboflow" rel="noopener" target="_blank" title="twitter.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.footer", "navigation.tracking", "navigation.indexes", "navigation.sections", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": 1.0}}</script>
<script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
<script src="https://widget.kapa.ai/kapa-widget.bundle.js"></script>
<script src="../../javascript/init_kapa_widget.js"></script>
<script src="../../javascript/cookbooks.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>